{% extends 'base.html' %}

{% block title %}Delivery Routes Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-5">
                <i class="fas fa-truck me-2"></i>Delivery Routes Dashboard
            </h1>
            <p class="text-muted">Monitor all delivery routes and orders</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50"></th>
                                    <th>Route Number</th>
                                    <th>Route Name</th>
                                    <th>Driver</th>
                                    <th>Del Date</th>
                                    <th width="200">Progress</th>
                                    <th width="140">Status</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if routes|length == 0 %}
                                <tr class="no-active-routes">
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle me-2"></i>No active routes found.
                                    </td>
                                </tr>
                                {% else %}
                                {% for summary in routes %}
                                <tr class="route-header {% if summary.route.status == 'IN_TRANSIT' %}in-transit-row{% endif %} {% if summary.progress['pct'] == 100 %}completed-row{% endif %}" 
                                    data-route-id="{{ summary.route.id }}"
                                    data-status="{{ summary.route.status }}"
                                    data-progress="{{ summary.progress['pct'] }}">
                                    <td>
                                        <button class="btn btn-sm btn-link expand-btn" data-route-id="{{ summary.route.id }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </td>
                                    <td><strong>#{{ summary.route.id }}</strong></td>
                                    <td>{{ summary.route.route_name or '-' }}</td>
                                    <td>{{ summary.route.driver_name or '-' }}</td>
                                    <td>{{ summary.route.delivery_date.strftime('%d/%m/%Y') if summary.route.delivery_date else '-' }}</td>
                                    <td>
                                        <div class="progress-container d-flex align-items-center gap-2">
                                            <div class="progress flex-grow-1 {% if summary.route.status == 'IN_TRANSIT' %}progress-striped progress-animated{% endif %}" style="height: 28px;">
                                                {% if summary.progress['pct'] == 100 %}
                                                <div class="progress-bar bg-success progress-complete" role="progressbar" 
                                                     style="width: 100%;" 
                                                     aria-valuenow="100" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    <i class="fas fa-check-circle"></i><span>100%</span>
                                                </div>
                                                {% elif summary.route.status == 'IN_TRANSIT' %}
                                                <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" role="progressbar" 
                                                     style="width: {{ summary.progress['pct'] if summary.progress['pct'] > 0 else 5 }}%;" 
                                                     aria-valuenow="{{ summary.progress['pct'] }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {% if summary.progress['pct'] > 15 %}<i class="fas fa-truck me-1"></i>{{ summary.progress['pct']|round|int }}%{% endif %}
                                                </div>
                                                {% else %}
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     style="width: {{ summary.progress['pct'] if summary.progress['pct'] > 0 else 5 }}%;" 
                                                     aria-valuenow="{{ summary.progress['pct'] }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {% if summary.progress['pct'] > 15 %}{{ summary.progress['pct']|round|int }}%{% endif %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="progress-text text-nowrap">
                                                <small class="text-muted">{{ summary.progress['done'] }}/{{ summary.progress['total'] }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if summary.route.status == 'PLANNED' %}
                                        <span class="badge bg-secondary fs-6">
                                            <i class="fas fa-clipboard-list me-1"></i>Planned
                                        </span>
                                        {% elif summary.route.status == 'DISPATCHED' %}
                                        <span class="badge bg-warning fs-6">
                                            <i class="fas fa-shipping-fast me-1"></i>Dispatched
                                        </span>
                                        {% elif summary.route.status == 'IN_TRANSIT' %}
                                        <span class="badge bg-primary fs-6 pulse-badge">
                                            <i class="fas fa-truck me-1"></i>In Transit
                                        </span>
                                        {% elif summary.route.status == 'COMPLETED' %}
                                        <span class="badge bg-success fs-6">
                                            <i class="fas fa-check-circle me-1"></i>Completed
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary fs-6">{{ summary.route.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('routes.detail', shipment_id=summary.route.id) }}" 
                                           class="btn btn-sm btn-info" target="_blank">
                                            <i class="fas fa-eye me-1"></i>View
                                        </a>
                                        {% if summary.route.status == 'PLANNED' and summary.all_ready_for_dispatch %}
                                        <form method="POST" action="{{ url_for('routes.mark_shipped', shipment_id=summary.route.id) }}" class="d-inline" onsubmit="return confirm('Dispatch route #{{ summary.route.id }}?')">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-truck me-1"></i>Dispatch
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr class="route-details" id="details-{{ summary.route.id }}" style="display: none;">
                                    <td colspan="8">
                                        <div class="p-3 bg-light">
                                            <h6 class="mb-3 text-dark">
                                                <i class="fas fa-box me-2"></i>Orders for Route #{{ summary.route.id }} - {{ summary.route.route_name or 'Unnamed Route' }}
                                            </h6>
                                            <div class="loading-message text-center py-3">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Loading orders...
                                            </div>
                                            <div class="orders-container" style="display: none;">
                                                <table class="table table-sm table-bordered mb-0 invoice-details-table">
                                                    <thead class="table-secondary">
                                                        <tr>
                                                            <th class="text-center">Stop #</th>
                                                            <th>Invoice No</th>
                                                            <th>Customer</th>
                                                            <th class="text-center">Seq</th>
                                                            <th>Status</th>
                                                            <th class="text-center">Items</th>
                                                            <th class="text-center">kg</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="orders-list">
                                                        <!-- Orders will be loaded here via AJAX -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle expand/collapse buttons
    document.querySelectorAll('.expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const routeId = this.dataset.routeId;
            const detailsRow = document.getElementById('details-' + routeId);
            const icon = this.querySelector('i');
            
            if (detailsRow.style.display === 'none') {
                // Expand: load orders if not already loaded
                if (!detailsRow.dataset.loaded) {
                    loadRouteOrders(routeId);
                }
                detailsRow.style.display = 'table-row';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                // Collapse
                detailsRow.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        });
    });
    
    function loadRouteOrders(routeId) {
        const detailsRow = document.getElementById('details-' + routeId);
        const loadingMsg = detailsRow.querySelector('.loading-message');
        const ordersContainer = detailsRow.querySelector('.orders-container');
        const ordersList = detailsRow.querySelector('.orders-list');
        
        // Show loading
        loadingMsg.style.display = 'block';
        ordersContainer.style.display = 'none';
        
        // Fetch orders
        fetch(`{{ url_for('delivery_dashboard.get_route_orders', route_id=0) }}`.replace('/0/', '/' + routeId + '/'))
            .then(response => response.json())
            .then(data => {
                // Build orders table
                ordersList.innerHTML = '';
                
                if (data.orders.length === 0) {
                    ordersList.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No orders found</td></tr>';
                } else {
                    data.orders.forEach(function(order) {
                        const statusBadge = getStatusBadge(order.status);
                        const row = `
                            <tr class="text-white">
                                <td class="text-center">${order.stop_seq || '-'}</td>
                                <td><strong>${order.invoice_no}</strong></td>
                                <td>${order.customer_name || '-'}</td>
                                <td class="text-center">${order.routing || '-'}</td>
                                <td>${statusBadge}</td>
                                <td class="text-center">${order.total_items || 0}</td>
                                <td class="text-center">${order.total_weight ? Math.round(order.total_weight) : '0'}</td>
                            </tr>
                        `;
                        ordersList.innerHTML += row;
                    });
                }
                
                // Hide loading, show orders
                loadingMsg.style.display = 'none';
                ordersContainer.style.display = 'block';
                
                // Mark as loaded
                detailsRow.dataset.loaded = 'true';
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                ordersList.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading orders</td></tr>';
                loadingMsg.style.display = 'none';
                ordersContainer.style.display = 'block';
            });
    }
    
    function getStatusBadge(status) {
        const badges = {
            'not_started': '<span class="badge bg-secondary">Not Started</span>',
            'picking': '<span class="badge bg-warning">Picking</span>',
            'awaiting_batch_items': '<span class="badge bg-warning">Awaiting Items</span>',
            'ready_for_dispatch': '<span class="badge bg-info">Ready</span>',
            'shipped': '<span class="badge bg-primary">Shipped</span>',
            'out_for_delivery': '<span class="badge bg-primary">Out for Delivery</span>',
            'delivered': '<span class="badge bg-success">Delivered</span>',
            'returned': '<span class="badge bg-warning">Returned</span>',
            'delivery_failed': '<span class="badge bg-danger">Failed</span>',
            'cancelled': '<span class="badge bg-danger">Cancelled</span>',
            'returned_to_warehouse': '<span class="badge bg-secondary">Returned to Warehouse</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
    }
});
</script>

<style>
.route-header {
    cursor: pointer;
    transition: all 0.3s ease;
}

.route-header:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* IN TRANSIT - Pulsing glow effect */
.in-transit-row {
    background-color: rgba(13, 110, 253, 0.05);
    border-left: 4px solid #0d6efd;
    animation: pulseGlow 2s ease-in-out infinite;
}

@keyframes pulseGlow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.3);
    }
    50% {
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.6);
    }
}

/* 100% COMPLETED - Success highlight */
.completed-row {
    background-color: rgba(25, 135, 84, 0.05);
    border-left: 4px solid #198754;
}

.completed-row:hover {
    background-color: rgba(25, 135, 84, 0.1);
}

/* Pulsing badge for IN TRANSIT */
.pulse-badge {
    animation: pulseBadge 1.5s ease-in-out infinite;
}

@keyframes pulseBadge {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 0 10px 3px rgba(13, 110, 253, 0.3);
    }
}

.expand-btn {
    padding: 0.25rem;
    color: #0d6efd;
    text-decoration: none;
}

.expand-btn:hover {
    color: #0a58ca;
    text-decoration: none;
}

.expand-btn:focus {
    outline: none;
    box-shadow: none;
}

.route-details td {
    padding: 0 !important;
}

.progress-container {
    min-width: 200px;
}

.progress {
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 8px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    background-color: #e9ecef;
}

.progress-bar {
    display: inline-flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    border-radius: 8px;
    transition: width 0.6s ease;
    white-space: nowrap;
}

.progress-bar i {
    display: inline;
    flex-shrink: 0;
}

.progress-bar span {
    display: inline;
    flex-shrink: 0;
}

.progress-text {
    font-size: 0.8rem;
    white-space: nowrap;
}

/* Special styling for 100% complete */
.progress-complete {
    background: linear-gradient(45deg, #198754, #20c997);
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(25, 135, 84, 0.4);
}

/* Badge sizing */
.badge.fs-6 {
    padding: 0.5em 0.8em;
    font-size: 0.95rem !important;
}

.invoice-details-table {
    font-size: 0.875rem;
}

.invoice-details-table th {
    font-size: 0.8rem;
    font-weight: 600;
}

.invoice-details-table td {
    font-size: 0.85rem;
}
</style>

{% endblock %}
