{% extends "base.html" %}

{% block title %}Deliver Stop - Driver App{% endblock %}

{% block head %}
<style>
/* Remove number input arrows */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-3" id="deliverApp" 
     data-stop-id="{{ stop.route_stop_id }}"
     data-route-id="{{ route.id }}"
     data-is-credit="{{ '1' if terms.is_credit else '0' }}"
     data-allow-cash="{{ '1' if terms.allow_cash else '0' }}"
     data-allow-cheque="{{ '1' if terms.allow_cheque else '0' }}"
     data-allow-online="{{ '1' if terms.allow_bank_transfer else '0' }}"
     data-allow-card="{{ '1' if terms.allow_card_pos else '0' }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('driver.stops_list', route_id=route.id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <h5 class="mb-0">Deliver Stop</h5>
        <span></span>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h6><i class="fas fa-user"></i> {{ stop.stop_name or stop.customer_name or 'Customer' }}</h6>
            <p class="mb-0 text-muted small">{{ stop.stop_addr }}</p>
        </div>
    </div>

    {% if stop.notes %}
    <div class="mb-3 p-3" style="background-color: #f5f5f5; border-left: 4px solid #6c757d; border-radius: 4px;">
        <div style="color: #000;"><i class="fas fa-sticky-note me-2"></i>{{ stop.notes }}</div>
    </div>
    {% endif %}

    {% if terms.is_credit %}
    <div class="alert alert-info mb-2">
        <strong><i class="fas fa-credit-card"></i> On Account (Credit)</strong> — Payment on account per credit terms.
        {% if terms.notes_for_driver %}
        <div class="small mt-1">{{ terms.notes_for_driver }}</div>
        {% endif %}
    </div>
    {% else %}
    {% if terms.notes_for_driver %}
    <div class="alert alert-warning mb-2">
        <strong><i class="fas fa-info-circle"></i> Note:</strong> {{ terms.notes_for_driver }}
    </div>
    {% endif %}
    {% endif %}

    <div class="card mb-3">
        <div class="card-header text-white" style="background-color: #fd7e14;">
            <strong><i class="fas fa-exclamation-triangle"></i> Exceptions</strong>
            <span class="badge bg-secondary float-end" id="exception-count">0</span>
        </div>
        <div class="card-body">
            <div id="exceptions-list"></div>
            <button class="btn btn-sm w-100" style="color: #fd7e14; border-color: #fd7e14;" onclick="addException()">
                <i class="fas fa-plus"></i> Add Exception
            </button>
        </div>
    </div>

    {% if not terms.is_credit %}
    <div class="card mb-3" id="codCard">
        <div class="card-header bg-success text-white">
            <strong><i class="fas fa-money-bill"></i> Payment</strong>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <label class="form-label">Payment Method</label>
                <select class="form-select" id="cod-method">
                    {% if terms.allow_cash %}
                    <option value="cash">Cash</option>
                    {% endif %}
                    {% if terms.allow_cheque %}
                    <option value="cheque">Cheque{% if terms.cheque_days_allowed %} ({{ terms.cheque_days_allowed }} days){% endif %}</option>
                    {% endif %}
                    {% if terms.allow_bank_transfer %}
                    <option value="online">Pay Online (bank transfer)</option>
                    {% endif %}
                    {% if terms.allow_card_pos %}
                    <option value="card">Card (POS)</option>
                    {% endif %}
                </select>
            </div>
            
            <div id="cod-amount-section">
                <div class="row g-2 mb-2 align-items-center">
                    <div class="col-4">
                        <label class="form-label small mb-1">Invoice Total</label>
                        <div class="fs-6">€<span id="cod-expected">0.00</span></div>
                    </div>
                    <div class="col-4" id="cod-variance-container">
                        <label class="form-label small mb-1">Balance Due</label>
                        <div class="fs-6"><span id="cod-variance">€ 0.00</span></div>
                    </div>
                    <div class="col-4" id="cod-received-container">
                        <label class="form-label fw-bold mb-1">Amount Collected</label>
                        <input type="number" step="0.01" class="form-control form-control-lg fw-bold" id="cod-received" placeholder="0.00" style="font-size: 1.25rem; min-width: 120px; -moz-appearance: textfield;">
                    </div>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Notes <span class="text-muted small">(required if balance due ≠ 0)</span></label>
                <textarea class="form-control" id="cod-notes" rows="2" placeholder="Optional"></textarea>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-body">
            <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="pod-physical">
                <label class="form-check-label fw-bold" for="pod-physical">
                    Physical signed invoice collected <span class="text-danger">*</span>
                </label>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" 
             style="cursor: pointer;" 
             onclick="togglePodDetails()">
            <strong><i class="fas fa-signature"></i> Additional Delivery Details</strong>
            <i class="fas fa-chevron-down" id="pod-chevron"></i>
        </div>
        <div class="card-body" id="pod-details" style="display: none;">
            <div class="mb-2">
                <label class="form-label">Receiver Name</label>
                <input type="text" class="form-control" id="pod-receiver" placeholder="Who received the order?">
            </div>
            <div class="mb-2">
                <label class="form-label">Relationship</label>
                <select class="form-select" id="pod-relationship">
                    <option value="owner">Owner</option>
                    <option value="employee">Employee</option>
                    <option value="family">Family Member</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="mb-2">
                <label class="form-label">Photos (Optional)</label>
                <input type="file" class="form-control" id="pod-photos" accept="image/*" multiple>
                <small class="text-muted">You can select multiple photos</small>
            </div>
            <div class="mb-0">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="pod-notes" rows="2" placeholder="Optional notes"></textarea>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2">
        <a href="{{ url_for('driver.print_stop_receipt_80mm', stop_id=stop.route_stop_id) }}" 
           target="_blank" 
           class="btn btn-primary btn-lg">
            <i class="fas fa-print"></i> Print Receipt (80mm)
        </a>
        <button class="btn btn-success btn-lg" onclick="submitDelivery()">
            <i class="fas fa-check-circle"></i> Complete Delivery
        </button>
    </div>
</div>

<div class="modal fade" id="exceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Exception</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Invoice</label>
                    <select class="form-select" id="ex-invoice">
                        {% for inv in invoice_nos %}
                        <option value="{{ inv }}">{{ inv }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Item</label>
                    <select class="form-select" id="ex-item" style="height: auto; min-height: 60px; white-space: normal; overflow: visible;">
                        <option value="">Select item...</option>
                    </select>
                    <div id="ex-expected-display" class="mt-2 text-muted small" style="display:none;"></div>
                </div>
                <div class="mb-3" id="qty-container" style="display:none;">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Exception Type</label>
                            <select class="form-select" id="ex-type">
                                <option value="SHORT">Short (Missing)</option>
                                <option value="DAMAGED">Damaged</option>
                                <option value="WRONG">Wrong Item</option>
                                <option value="REJECTED">Customer Rejected</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Qty</label>
                            <input type="number" step="0.01" class="form-control" id="ex-qty" placeholder="0">
                        </div>
                    </div>
                </div>
                <div class="mb-3" id="damaged-accept-container" style="display:none;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ex-damaged-accept">
                        <label class="form-check-label" for="ex-damaged-accept">
                            Customer accepted damaged item
                        </label>
                    </div>
                </div>
                <div id="actual-item-container" style="display:none;">
                    <div class="alert alert-info small mb-3">
                        <i class="fas fa-info-circle"></i> Enter the item that was actually delivered instead
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actual Item Barcode</label>
                        <input type="text" class="form-control" id="ex-actual-barcode" placeholder="Scan or enter barcode">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actual Item Code (Optional)</label>
                        <input type="text" class="form-control" id="ex-actual-code" placeholder="Enter item code if known">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="ex-notes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveException()">Add Exception</button>
            </div>
        </div>
    </div>
</div>

<script>
const items = {{ items|tojson }};
const invoiceNos = {{ invoice_nos|tojson }};
const invoices = {{ invoices|tojson }};
const totalInvoicesAmount = {{ total_invoices_amount }};
const routeId = {{ route.id }};
const stopId = {{ stop.route_stop_id }};
const exceptions = [];

// Get credit terms from data attributes
const app = document.getElementById('deliverApp');
const isCredit = app.dataset.isCredit === '1';
const allowCash = app.dataset.allowCash === '1';
const allowCheque = app.dataset.allowCheque === '1';
const allowOnline = app.dataset.allowOnline === '1';
const allowCard = app.dataset.allowCard === '1';

function populateItems() {
    const invoiceNo = document.getElementById('ex-invoice').value;
    const itemSelect = document.getElementById('ex-item');
    
    itemSelect.innerHTML = '<option value="">Select item...</option>';
    
    const invoiceItems = items.filter(item => item.invoice_no === invoiceNo);
    invoiceItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.item_code;
        option.textContent = `${item.item_code} - ${item.item_name}`;
        option.dataset.item = JSON.stringify(item);
        itemSelect.appendChild(option);
    });
    
    // Reset quantity container when invoice changes
    document.getElementById('qty-container').style.display = 'none';
    document.getElementById('ex-expected-display').textContent = '';
    document.getElementById('ex-expected-display').style.display = 'none';
    document.getElementById('ex-qty').value = '';
}

document.getElementById('ex-invoice').addEventListener('change', populateItems);

document.getElementById('ex-item').addEventListener('change', function() {
    const qtyContainer = document.getElementById('qty-container');
    const expectedDisplay = document.getElementById('ex-expected-display');
    
    if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        const item = JSON.parse(selectedOption.dataset.item);
        
        // Format: "1 CASE X24" (qty_ordered unit_type X pack)
        let displayText = `${item.qty_ordered} ${item.unit_type || ''}`;
        if (item.pack) {
            displayText += ` X${item.pack}`;
        }
        
        expectedDisplay.textContent = displayText;
        expectedDisplay.style.display = 'block';
        qtyContainer.style.display = 'block';
    } else {
        qtyContainer.style.display = 'none';
        expectedDisplay.style.display = 'none';
        expectedDisplay.textContent = '';
    }
});

document.getElementById('ex-type').addEventListener('change', function() {
    const damagedContainer = document.getElementById('damaged-accept-container');
    const actualContainer = document.getElementById('actual-item-container');
    
    damagedContainer.style.display = this.value === 'DAMAGED' ? 'block' : 'none';
    actualContainer.style.display = this.value === 'WRONG' ? 'block' : 'none';
});

function addException() {
    // Reset all form fields when opening modal
    document.getElementById('ex-qty').value = '';
    document.getElementById('ex-notes').value = '';
    document.getElementById('ex-actual-barcode').value = '';
    document.getElementById('ex-actual-code').value = '';
    document.getElementById('qty-container').style.display = 'none';
    document.getElementById('ex-expected-display').textContent = '';
    document.getElementById('ex-expected-display').style.display = 'none';
    
    populateItems();
    const modal = new bootstrap.Modal(document.getElementById('exceptionModal'));
    modal.show();
}

function saveException() {
    const invoiceNo = document.getElementById('ex-invoice').value;
    const itemCode = document.getElementById('ex-item').value;
    const type = document.getElementById('ex-type').value;
    const qtyInput = document.getElementById('ex-qty').value;
    const qty = parseFloat(qtyInput);
    const notes = document.getElementById('ex-notes').value;
    const damagedAccepted = document.getElementById('ex-damaged-accept').checked;
    
    if (!itemCode) {
        alert('Please select an item');
        return;
    }
    
    if (!qtyInput || isNaN(qty) || qty < 0) {
        alert('Please enter a valid quantity (0 or greater for missing items)');
        return;
    }
    
    const selectedOption = document.querySelector('#ex-item option:checked');
    const item = JSON.parse(selectedOption.dataset.item);
    
    // Capture actual item data for WRONG/substitution type
    const actual = (type === 'WRONG') ? {
        barcode: document.getElementById('ex-actual-barcode').value.trim() || null,
        item_code: document.getElementById('ex-actual-code').value.trim() || null,
        qty: qty
    } : null;
    
    exceptions.push({
        invoice_no: invoiceNo,
        item_code: itemCode,
        item_name: item.item_name,
        type: type,
        qty: qty,
        qty_ordered: item.qty_ordered,
        unit_type: item.unit_type,
        notes: notes,
        damagedAccepted: damagedAccepted,
        actual: actual
    });
    
    renderExceptions();
    bootstrap.Modal.getInstance(document.getElementById('exceptionModal')).hide();
    
    // Reset form
    document.getElementById('ex-qty').value = '';
    document.getElementById('ex-notes').value = '';
    document.getElementById('ex-actual-barcode').value = '';
    document.getElementById('ex-actual-code').value = '';
    document.getElementById('qty-container').style.display = 'none';
    document.getElementById('ex-expected-display').textContent = '-';
}

function renderExceptions() {
    const list = document.getElementById('exceptions-list');
    list.innerHTML = '';
    
    exceptions.forEach((ex, index) => {
        const typeColors = {
            'SHORT': '#dc3545',
            'DAMAGED': '#dc3545',
            'WRONG': '#0dcaf0',
            'REJECTED': '#6c757d'
        };
        const typeColor = typeColors[ex.type] || '#6c757d';
        
        const typeLabels = {
            'SHORT': 'Short Missing',
            'DAMAGED': 'Damaged',
            'WRONG': 'Wrong Item',
            'REJECTED': 'Customer Rejected'
        };
        const typeLabel = typeLabels[ex.type] || ex.type;
        
        const unitText = ex.unit_type ? ` ${ex.unit_type}` : '';
        const qtyText = `${ex.qty}${unitText}`;
        const expectedQty = `${ex.qty_ordered}${unitText}`;
        const deliveredQty = ex.qty_ordered - ex.qty;
        const deliveredText = `${deliveredQty}${unitText}`;
        
        const notesText = ex.notes ? ` | ${ex.notes}` : '';
        
        const div = document.createElement('div');
        div.className = 'alert alert-warning d-flex align-items-start';
        div.innerHTML = `
            <button type="button" class="btn btn-sm" onclick="removeException(${index})" style="background: none; border: none; font-size: 1.5rem; line-height: 1; color: #000; padding: 0; margin-right: 10px; cursor: pointer;">×</button>
            <div style="flex: 1;">
                <strong><span style="color: ${typeColor};">${typeLabel}</span></strong> ${qtyText}${notesText}<br>
                <small>${ex.item_name}<br>Expected: ${expectedQty} | Delivered: ${deliveredText}</small>
            </div>
        `;
        list.appendChild(div);
    });
    
    document.getElementById('exception-count').textContent = exceptions.length;
}

function removeException(index) {
    exceptions.splice(index, 1);
    renderExceptions();
}

// Toggle payment controls based on method selection
function togglePaymentControls() {
    if (isCredit) return; // No payment controls for credit accounts
    
    const methodEl = document.getElementById('cod-method');
    if (!methodEl) return;
    
    const method = methodEl.value;
    const amountSection = document.getElementById('cod-amount-section');
    const receivedInput = document.getElementById('cod-received');
    const receivedContainer = document.getElementById('cod-received-container');
    const varianceContainer = document.getElementById('cod-variance-container');
    
    if (method === 'online') {
        // Online/Bank Transfer - show expected amount only, no cash collected
        if (amountSection) amountSection.style.display = 'block';
        if (receivedInput) receivedInput.value = '0';
        if (receivedContainer) receivedContainer.style.display = 'none';
        if (varianceContainer) varianceContainer.style.display = 'none';
    } else {
        // Cash/Cheque/Card - show full amount collection
        if (amountSection) amountSection.style.display = 'block';
        if (receivedContainer) receivedContainer.style.display = 'block';
        if (varianceContainer) varianceContainer.style.display = 'block';
    }
    
    calculateCODVariance();
}

// Calculate COD expected and balance due
function calculateCODVariance() {
    if (isCredit) return; // No COD for credit accounts
    
    // Use total invoice amounts as expected
    const expected = totalInvoicesAmount;
    
    const codExpected = document.getElementById('cod-expected');
    if (codExpected) codExpected.textContent = expected.toFixed(2);
    
    const methodEl = document.getElementById('cod-method');
    const method = methodEl ? methodEl.value : 'cash';
    
    const receivedInput = document.getElementById('cod-received');
    const received = method === 'online' ? 0 : (parseFloat(receivedInput?.value) || 0);
    
    // Balance Due = Invoice Total - Amount Collected
    // Positive = we're owed money, Negative = customer overpaid, 0 = paid exactly
    const balanceDue = expected - received;
    const varianceEl = document.getElementById('cod-variance');
    if (varianceEl) varianceEl.textContent = `€ ${balanceDue.toFixed(2)}`;
}

// Set up payment method change listener
if (!isCredit) {
    const methodEl = document.getElementById('cod-method');
    if (methodEl) {
        methodEl.addEventListener('change', togglePaymentControls);
    }
    
    const receivedInput = document.getElementById('cod-received');
    if (receivedInput) {
        receivedInput.addEventListener('input', calculateCODVariance);
        receivedInput.addEventListener('focus', function() {
            this.select();
        });
        receivedInput.addEventListener('click', function() {
            this.select();
        });
    }
    
    // Initialize on load
    togglePaymentControls();
    calculateCODVariance();
}

// Toggle POD details expansion
function togglePodDetails() {
    const details = document.getElementById('pod-details');
    const chevron = document.getElementById('pod-chevron');
    if (details.style.display === 'none') {
        details.style.display = 'block';
        chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
    } else {
        details.style.display = 'none';
        chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
    }
}

async function submitDelivery() {
    // Validate physical signed invoice checkbox
    const hasPhysicalInvoice = document.getElementById('pod-physical').checked;
    const codMethodEl = document.getElementById('cod-method');
    const codMethod = codMethodEl ? codMethodEl.value : null;
    const receivedAmountInput = document.getElementById('cod-received');
    const receivedAmount = !isCredit ? (parseFloat(receivedAmountInput?.value) || 0) : 0;
    
    // Mandatory Physical Invoice for Credit OR Online Payment OR No Cash Collected
    if ((isCredit || codMethod === 'online' || receivedAmount === 0) && !hasPhysicalInvoice) {
        alert('Physical signed invoice must be collected for this delivery method.');
        return;
    }

    // If payment method is Cash, do not allow completing delivery without amount collected
    if (!isCredit && codMethod === 'cash' && (receivedAmount <= 0)) {
        alert('Please enter the cash amount collected.');
        receivedAmountInput.focus();
        return;
    }
    
    if (!confirm('Complete this delivery?')) return;
    
    try {
        let gps = null;
        if (navigator.geolocation) {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
            }).catch(() => null);
            if (position) {
                gps = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
            }
        }
        
        // Build COD payload based on credit terms
        let codPayload = null;
        if (!isCredit) {
            const method = document.getElementById('cod-method').value;
            const received = method === 'online' ? 0 : (parseFloat(document.getElementById('cod-received').value) || 0);
            const note = document.getElementById('cod-notes').value;
            
            codPayload = {
                method: method,
                received: received,
                note: note
            };
        }
        
        const payload = {
            exceptions: exceptions,
            invoice_nos: invoiceNos,
            cod: codPayload,  // null for credit accounts
            pod: {
                has_physical_signed_invoice: document.getElementById('pod-physical').checked,
                receiver_name: document.getElementById('pod-receiver').value,
                receiver_relationship: document.getElementById('pod-relationship').value,
                notes: document.getElementById('pod-notes').value,
                photos: []
            },
            gps: gps
        };
        
        const response = await fetch(`/driver/stops/${stopId}/deliver`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            const msg = isCredit ? 
                'Delivery completed (Credit Account)' : 
                `Delivery completed! COD Collected: €${data.cod.received.toFixed(2)}`;
            alert(msg);
            window.location.href = `/driver/routes/${routeId}/stops`;
        } else {
            alert(data.error || 'Failed to complete delivery');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error completing delivery. Please try again.');
    }
}
</script>
{% endblock %}
