{% extends "base.html" %}

{% block title %}Warehouse Intake - Post-Delivery Cases{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-warehouse"></i> Warehouse Intake Dashboard
            </h2>

            <ul class="nav nav-tabs mb-4" id="intakeTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="failed-tab" data-toggle="tab" href="#failed" role="tab">
                        Failed Deliveries <span class="badge badge-primary">{{ failed_invoices|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="reroute-tab" data-toggle="tab" href="#reroute" role="tab">
                        Reroute Queue <span class="badge badge-info">{{ reroute_requests|length }}</span>
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="intakeTabContent">
                <!-- Failed Deliveries Tab -->
                <div class="tab-pane fade show active" id="failed" role="tabpanel">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> This shows only complete delivery failures. Partial delivery issues (short picks, damaged items, wrong items) are tracked separately in Delivery Issues.
                    </div>
                    
                    {% if failed_invoices %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Invoice</th>
                                    <th>Customer</th>
                                    <th>Route</th>
                                    <th>Status</th>
                                    <th>Total Items</th>
                                    <th>Failed Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in failed_invoices %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('admin_view_invoice', invoice_no=invoice.invoice_no) }}" target="_blank">
                                            {{ invoice.invoice_no }}
                                        </a>
                                    </td>
                                    <td>{{ invoice.customer_name or '-' }}</td>
                                    <td>
                                        {% if invoice.route_id %}
                                        <a href="{{ url_for('routes.detail', shipment_id=invoice.route_id) }}" target="_blank">
                                            Route #{{ invoice.route_id }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-danger">DELIVERY FAILED</span>
                                    </td>
                                    <td>{{ invoice.total_items or 0 }}</td>
                                    <td>{{ invoice.updated_at.strftime('%Y-%m-%d %H:%M') if invoice.updated_at else '-' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-primary" onclick="assignToRoute('{{ invoice.invoice_no }}', null, null)">
                                                <i class="fas fa-truck"></i> Reroute
                                            </button>
                                            <button class="btn btn-warning" 
                                                    onclick="returnToWarehouse('{{ invoice.invoice_no }}')"
                                                    data-case-id="{{ invoice._intake_case.id if invoice._intake_case else '' }}">
                                                <i class="fas fa-archive"></i> Return to Warehouse
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No failed deliveries at the moment.
                    </div>
                    {% endif %}
                </div>

                <!-- Reroute Queue Tab -->
                <div class="tab-pane fade" id="reroute" role="tabpanel">
                    {% if reroute_requests %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Request ID</th>
                                    <th>Invoice</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Requested At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in reroute_requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td>
                                        <a href="{{ url_for('admin_view_invoice', invoice_no=req.invoice_no) }}" target="_blank">
                                            {{ req.invoice_no }}
                                        </a>
                                    </td>
                                    <td>{{ req.invoice.customer_name if req.invoice else '-' }}</td>
                                    <td>
                                        <span class="badge badge-primary">{{ req.status }}</span>
                                    </td>
                                    <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') if req.created_at else '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="assignToRoute('{{ req.invoice_no }}', {{ req.id }})">
                                            <i class="fas fa-truck"></i> Assign to Route
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No pending reroute requests.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Route Assignment Modal -->
<div class="modal fade" id="assignRouteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Invoice to Route</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Invoice: <strong id="modalInvoiceNo"></strong></p>
                
                <!-- Route Options -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="routeOption" id="existingRouteOption" value="existing" checked onchange="toggleRouteOption()">
                    <label class="form-check-label" for="existingRouteOption">
                        <strong>Assign to Existing Route</strong>
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="routeOption" id="newRouteOption" value="new" onchange="toggleRouteOption()">
                    <label class="form-check-label" for="newRouteOption">
                        <strong>Create New Route</strong>
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="routeOption" id="warehouseCollectionOption" value="warehouse" onchange="toggleRouteOption()">
                    <label class="form-check-label" for="warehouseCollectionOption">
                        <strong>Collect from Warehouse</strong>
                        <small class="text-muted d-block">Mark as delivered (customer pickup)</small>
                    </label>
                </div>
                
                <!-- Existing Route Section -->
                <div id="existingRouteSection">
                    <div class="mb-3">
                        <label for="existingRoute" class="form-label">Select Route</label>
                        <select class="form-select" id="existingRoute">
                            <option value="">-- Select Route --</option>
                            {% for route in available_routes %}
                            <option value="{{ route.id }}">
                                Route #{{ route.id }}: {{ route.driver_name }} - {{ route.delivery_date.strftime('%d/%m/%Y') }} ({{ route.status }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- New Route Section -->
                <div id="newRouteSection" style="display: none;">
                    <div class="mb-3">
                        <label for="newDriver" class="form-label">Driver</label>
                        <select class="form-select" id="newDriver" required>
                            <option value="">-- Select Driver --</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.username }}">{{ driver.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="newRouteName" class="form-label">Route Name <span class="text-muted">(Optional)</span></label>
                        <input type="text" class="form-control" id="newRouteName" placeholder="e.g., Downtown Route A">
                    </div>
                    <div class="mb-3">
                        <label for="newRouteDate" class="form-label">Delivery Date</label>
                        <input type="date" class="form-control" id="newRouteDate" required>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Invoice will be automatically grouped with other invoices for the same customer on the route.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitRouteAssignment()">
                    <i class="fas fa-check me-1"></i>Assign to Route
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remainder Details Modal -->
<div class="modal fade" id="remainderModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Remainder Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="remainderContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Route assignment state
let currentInvoiceNo = null;
let currentRerouteRequestId = null;
let currentCaseId = null;

function assignToRoute(invoiceNo, rerouteRequestId, caseId) {
    currentInvoiceNo = invoiceNo;
    currentRerouteRequestId = rerouteRequestId || null;
    currentCaseId = caseId || null;
    
    document.getElementById('modalInvoiceNo').textContent = invoiceNo;
    document.getElementById('existingRouteOption').checked = true;
    toggleRouteOption();
    
    const modal = new bootstrap.Modal(document.getElementById('assignRouteModal'));
    modal.show();
}

function toggleRouteOption() {
    const isExisting = document.getElementById('existingRouteOption').checked;
    const isNew = document.getElementById('newRouteOption').checked;
    const isWarehouse = document.getElementById('warehouseCollectionOption').checked;
    const existingSection = document.getElementById('existingRouteSection');
    const newSection = document.getElementById('newRouteSection');
    
    if (isExisting) {
        existingSection.style.display = 'block';
        newSection.style.display = 'none';
    } else if (isNew) {
        existingSection.style.display = 'none';
        newSection.style.display = 'block';
    } else if (isWarehouse) {
        existingSection.style.display = 'none';
        newSection.style.display = 'none';
    }
}

async function submitRouteAssignment() {
    const isExisting = document.getElementById('existingRouteOption').checked;
    const isNew = document.getElementById('newRouteOption').checked;
    const isWarehouse = document.getElementById('warehouseCollectionOption').checked;
    
    let payload = {
        invoice_no: currentInvoiceNo,
        reroute_request_id: currentRerouteRequestId,
        case_id: currentCaseId
    };
    
    if (isWarehouse) {
        // Warehouse collection - mark as delivered
        payload.warehouse_collection = true;
    } else if (isExisting) {
        const routeId = document.getElementById('existingRoute').value;
        if (!routeId) {
            alert('Please select a route');
            return;
        }
        payload.route_id = routeId;
    } else if (isNew) {
        const driver = document.getElementById('newDriver').value;
        const date = document.getElementById('newRouteDate').value;
        
        if (!driver || !date) {
            alert('Please fill in all required fields');
            return;
        }
        
        payload.create_new_route = true;
        payload.driver_name = driver;
        payload.route_name = document.getElementById('newRouteName').value;
        payload.delivery_date = date;
    }
    
    try {
        const response = await fetch('/warehouse/assign-to-route', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message || 'Successfully assigned to route');
            window.location.reload();
        } else {
            alert(result.error || 'Failed to assign to route');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function queueReroute(caseId) {
    const notes = prompt('Add reroute notes (optional):');
    if (notes === null) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/warehouse/cases/${caseId}/reroute`;
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'notes';
    notesInput.value = notes;
    form.appendChild(notesInput);
    
    document.body.appendChild(form);
    form.submit();
}

function returnToStock(caseId) {
    if (!confirm('Return remainder to stock and close this case?')) return;
    
    const notes = prompt('Add notes about return (optional):');
    if (notes === null) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/warehouse/cases/${caseId}/return-to-stock`;
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'notes';
    notesInput.value = notes;
    form.appendChild(notesInput);
    
    document.body.appendChild(form);
    form.submit();
}

function returnToWarehouse(invoiceNo) {
    if (!confirm(`Return invoice ${invoiceNo} to warehouse?\n\nThis will:\n- Close the delivery case\n- Change invoice status to "returned_to_warehouse"\n- Generate a location-sorted put-away list for the picker`)) return;
    
    const notes = prompt('Add notes about return (optional):');
    if (notes === null) return;
    
    // Find the case_id for this invoice
    const caseId = document.querySelector(`button[onclick*="returnToWarehouse('${invoiceNo}')"]`)?.dataset?.caseId;
    
    if (caseId) {
        // Use the existing return-to-stock flow which redirects to put-away list
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/warehouse/cases/${caseId}/return-to-stock`;
        
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = notes;
        form.appendChild(notesInput);
        
        document.body.appendChild(form);
        form.submit();
    } else {
        alert('Error: Could not find warehouse intake case for this invoice');
    }
}

function viewRemainder(invoiceNo) {
    $('#remainderModal').modal('show');
    $('#remainderContent').html('<div class="text-center"><div class="spinner-border"></div></div>');
    
    fetch(`/warehouse/invoice/${invoiceNo}/remainder`)
        .then(r => r.json())
        .then(data => {
            let html = `
                <h5>Invoice: ${data.invoice_no}</h5>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Has Remainder:</strong> ${data.has_remainder ? 'Yes' : 'No'}</p>
                <hr>
                <h6>Items:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Ordered</th>
                            <th>Delivered</th>
                            <th>Remainder</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.items.forEach(item => {
                const rowClass = item.remainder > 0 ? 'table-warning' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${item.item_code}</td>
                        <td>${item.item_name}</td>
                        <td>${item.ordered}</td>
                        <td>${item.delivered}</td>
                        <td><strong>${item.remainder}</strong></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            $('#remainderContent').html(html);
        })
        .catch(err => {
            $('#remainderContent').html(`<div class="alert alert-danger">Error loading details: ${err}</div>`);
        });
}
</script>
{% endblock %}
