{% extends 'base.html' %}

{% block title %}Find Invoice/Route - EPLATTFORMA{% endblock %}

{% block content %}
<style>
    .filter-card {
        position: sticky;
        top: 20px;
    }
    .results-table {
        font-size: 0.9rem;
    }
    .results-table th, .results-table td {
        padding: 0.5rem;
        vertical-align: middle;
    }
    .kpi-card {
        border-left: 4px solid;
    }
    .kpi-card.invoices { border-left-color: #0d6efd; }
    .kpi-card.items { border-left-color: #198754; }
    .kpi-card.weight { border-left-color: #ffc107; }
    
    /* Print Styles */
    @media print {
        /* Hide everything except modal content */
        body * {
            visibility: hidden;
        }
        
        .modal-content, .modal-content * {
            visibility: visible;
        }
        
        .modal-dialog {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            max-width: 100%;
            width: 100%;
        }
        
        .modal-content {
            border: none;
            box-shadow: none;
        }
        
        /* Hide modal header buttons */
        .no-print {
            display: none !important;
        }
        
        /* Compact table spacing */
        .table-sm th, .table-sm td {
            padding: 0.15rem 0.3rem;
            font-size: 0.75rem;
        }
        
        h6 {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        p {
            margin-bottom: 0.2rem;
            font-size: 0.85rem;
        }
        
        .row {
            margin-bottom: 0.5rem;
        }
        
        /* Ensure tables don't break across pages */
        .table-responsive {
            page-break-inside: avoid;
        }
        
        /* Page breaks */
        .page-break {
            page-break-after: always;
        }
        
        @page {
            margin: 1cm;
            size: A4;
        }
    }
</style>

<div class="row mb-3">
    <div class="col-12">
        <h2><i class="fas fa-search me-2"></i>Find Invoice/Route</h2>
        <p class="text-muted">Search completed invoices with route and delivery details</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4" id="kpi-section" style="display: none;">
    <div class="col-md-4">
        <div class="card kpi-card invoices">
            <div class="card-body">
                <h6 class="text-muted">Total Invoices</h6>
                <h3 class="mb-0" id="kpi-invoices">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card items">
            <div class="card-body">
                <h6 class="text-muted">Total Items</h6>
                <h3 class="mb-0" id="kpi-items">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card weight">
            <div class="card-body">
                <h6 class="text-muted">Total Weight (kg)</h6>
                <h3 class="mb-0" id="kpi-weight">0</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left: Filters -->
    <div class="col-md-3 mb-4">
        <div class="card filter-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
            </div>
            <div class="card-body">
                <!-- Text Search -->
                <div class="mb-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="filter-search" placeholder="Invoice #, Customer...">
                </div>

                <!-- Date Presets -->
                <div class="mb-3">
                    <label class="form-label">Quick Dates</label>
                    <select class="form-select" id="filter-preset">
                        <option value="">Custom dates...</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7">Last 7 days</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                    </select>
                </div>

                <!-- Completed Date Range -->
                <div class="mb-3">
                    <label class="form-label">Completed From</label>
                    <input type="date" class="form-control" id="filter-completed-from">
                </div>
                <div class="mb-3">
                    <label class="form-label">Completed To</label>
                    <input type="date" class="form-control" id="filter-completed-to">
                </div>

                <!-- Delivered Date Range -->
                <div class="mb-3">
                    <label class="form-label">Delivered From</label>
                    <input type="date" class="form-control" id="filter-delivered-from">
                </div>
                <div class="mb-3">
                    <label class="form-label">Delivered To</label>
                    <input type="date" class="form-control" id="filter-delivered-to">
                </div>

                <!-- Customer -->
                <div class="mb-3">
                    <label class="form-label">Customer Code</label>
                    <input type="text" class="form-control" id="filter-customer" placeholder="e.g., C001">
                </div>

                <!-- Route -->
                <div class="mb-3">
                    <label class="form-label">Route Number</label>
                    <input type="text" class="form-control" id="filter-route" placeholder="e.g., 134">
                </div>

                <!-- Driver -->
                <div class="mb-3">
                    <label class="form-label">Driver</label>
                    <input type="text" class="form-control" id="filter-driver" placeholder="Driver name">
                </div>

                <!-- Status -->
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filter-status">
                        <option value="">All Statuses</option>
                        <option value="ready_for_dispatch">Ready for Dispatch</option>
                        <option value="shipped">Shipped</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="delivery_failed">Delivery Failed</option>
                    </select>
                </div>

                <!-- Sort -->
                <div class="mb-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="filter-sort">
                        <option value="completed_desc">Picked (Newest)</option>
                        <option value="completed_asc">Picked (Oldest)</option>
                        <option value="invoice_desc">Invoice # (Z-A)</option>
                        <option value="invoice_asc">Invoice # (A-Z)</option>
                    </select>
                </div>

                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Right: Results Table -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Results</h5>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-primary btn-sm" onclick="searchInvoices()">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="btn-group-view" onclick="toggleGroupView()" style="display: none;">
                        <i class="fas fa-layer-group me-1"></i>Group by Route
                    </button>
                    <span class="badge bg-secondary" id="result-count">0 results</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div id="loading-state" style="display: none;" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching invoices...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Use the filters to search for completed invoices</p>
                </div>

                <!-- Results Table (List View) -->
                <div id="results-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover results-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Picked</th>
                                    <th>Delivered</th>
                                    <th>Customer</th>
                                    <th>Route</th>
                                    <th>Driver</th>
                                    <th>Status</th>
                                    <th>Lines</th>
                                    <th>Items</th>
                                    <th>Weight (kg)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="text-muted" id="pagination-info">Showing 0-0 of 0</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" id="prev-page" onclick="previousPage()" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <button class="btn btn-outline-primary btn-sm" id="next-page" onclick="nextPage()" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grouped View (Group by Route) -->
                <div id="grouped-container" style="display: none;">
                    <div id="grouped-routes"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Invoice Details</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-primary no-print" onclick="printInvoiceDetail()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                    <button type="button" class="btn-close no-print" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let totalCount = 0;
const pageSize = 50;
let currentResults = null;
let currentView = 'list';

function searchInvoices(page = 1) {
    currentPage = page;
    
    // Show loading
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('results-container').style.display = 'none';
    
    // Build request data
    const data = {
        q: document.getElementById('filter-search').value,
        preset: document.getElementById('filter-preset').value,
        completed_from: document.getElementById('filter-completed-from').value,
        completed_to: document.getElementById('filter-completed-to').value,
        delivered_from: document.getElementById('filter-delivered-from').value,
        delivered_to: document.getElementById('filter-delivered-to').value,
        customer_code: document.getElementById('filter-customer').value,
        route_id: document.getElementById('filter-route').value,
        driver: document.getElementById('filter-driver').value,
        status: document.getElementById('filter-status').value,
        sort: document.getElementById('filter-sort').value,
        page: page,
        size: pageSize
    };
    
    // Call API
    fetch('/api/search-completed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        displayResults(result);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('empty-state').innerHTML = `
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <p class="text-danger">Error loading results. Please try again.</p>
        `;
        document.getElementById('empty-state').style.display = 'block';
    });
}

function displayResults(result) {
    document.getElementById('loading-state').style.display = 'none';
    
    if (result.items.length === 0) {
        document.getElementById('empty-state').innerHTML = `
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">No invoices found matching your criteria</p>
        `;
        document.getElementById('empty-state').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('grouped-container').style.display = 'none';
        document.getElementById('kpi-section').style.display = 'none';
        document.getElementById('view-toggle').style.display = 'none';
        return;
    }
    
    // Store current results
    currentResults = result;
    
    // Show KPIs
    document.getElementById('kpi-invoices').textContent = result.totals.total_invoices || 0;
    document.getElementById('kpi-items').textContent = result.totals.total_items || 0;
    document.getElementById('kpi-weight').textContent = result.totals.total_weight || 0;
    document.getElementById('kpi-section').style.display = 'flex';
    
    // Show group button
    document.getElementById('btn-group-view').style.display = 'inline-block';
    
    // Display results based on current view
    totalCount = result.count;
    
    if (currentView === 'list') {
        renderListView(result.items);
    } else {
        renderGroupedView(result.items);
    }
}

function renderListView(items) {
    document.getElementById('results-container').style.display = 'block';
    document.getElementById('grouped-container').style.display = 'none';
    
    const tbody = document.getElementById('results-tbody');
    tbody.innerHTML = '';
    
    items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.invoice_no}</strong></td>
            <td>${item.completed_at ? formatDate(item.completed_at) : '-'}</td>
            <td>${item.delivered_at ? formatDate(item.delivered_at) : '-'}</td>
            <td>
                <div class="text-truncate" style="max-width: 150px;" title="${item.customer_name}">
                    ${item.customer_code ? item.customer_code + ' - ' : ''}${item.customer_name}
                </div>
            </td>
            <td>${item.route_id ? 'Route #' + item.route_id + (item.route_name ? ' - ' + item.route_name : '') : '-'}</td>
            <td>${item.driver_name || '-'}</td>
            <td>${getStatusBadge(item.status)}</td>
            <td>${item.total_lines}</td>
            <td>${item.total_items}</td>
            <td>${item.total_weight}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewInvoiceDetail('${item.invoice_no}')">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalCount);
    document.getElementById('pagination-info').textContent = `Showing ${start}-${end} of ${totalCount}`;
    document.getElementById('result-count').textContent = `${totalCount} results`;
    
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = end >= totalCount;
    
    document.getElementById('results-container').style.display = 'block';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-GB', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getStatusBadge(status) {
    const badges = {
        'ready_for_dispatch': '<span class="badge bg-primary">Ready for Dispatch</span>',
        'shipped': '<span class="badge bg-success">Shipped</span>',
        'out_for_delivery': '<span class="badge bg-info">Out for Delivery</span>',
        'delivered': '<span class="badge bg-success">Delivered</span>',
        'delivery_failed': '<span class="badge bg-danger">Delivery Failed</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function viewInvoiceDetail(invoiceNo) {
    const modal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
    document.getElementById('modal-title').innerHTML = `<i class="fas fa-file-invoice me-2"></i>Invoice: ${invoiceNo}`;
    document.getElementById('modal-body').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    modal.show();
    
    // Fetch detail
    fetch(`/api/invoice-detail/${invoiceNo}`)
        .then(response => response.json())
        .then(data => {
            displayInvoiceDetail(data);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modal-body').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error loading invoice details
                </div>
            `;
        });
}

function displayInvoiceDetail(data) {
    let html = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted">Invoice Information</h6>
                <p><strong>Invoice #:</strong> ${data.invoice_no}</p>
                <p><strong>Status:</strong> ${getStatusBadge(data.status)}</p>
                <p><strong>Picked:</strong> ${data.completed_at ? formatDate(data.completed_at) : '-'}${data.picker_username ? ' by ' + data.picker_username : ''}</p>
                <p><strong>Shipped:</strong> ${data.shipped_at ? formatDate(data.shipped_at) : '-'}</p>
                <p><strong>Delivered:</strong> ${data.delivered_at ? formatDate(data.delivered_at) : '-'}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted">Customer & Route</h6>
                <p><strong>Customer:</strong> ${data.customer_code ? data.customer_code + ' - ' : ''}${data.customer_name}</p>
                <p><strong>Route:</strong> ${data.route_name || '-'}</p>
                <p><strong>Driver:</strong> ${data.driver_name || '-'}</p>
                <p><strong>Delivery Date:</strong> ${data.delivery_date ? new Date(data.delivery_date).toLocaleDateString('en-GB') : '-'}</p>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-12">
                <h6 class="text-muted">Totals</h6>
                <p><strong>Lines:</strong> ${data.total_lines} | <strong>Items:</strong> ${data.total_items} | <strong>Weight:</strong> ${data.total_weight} kg</p>
            </div>
        </div>
        
        <h6 class="text-muted mb-3">Line Items</h6>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Item Code</th>
                        <th>Item Name</th>
                        <th>Location</th>
                        <th>Zone</th>
                        <th>Qty</th>
                        <th>Picked</th>
                        <th>Delivered</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.items.forEach(item => {
        // Calculate delivered quantity considering discrepancies
        let deliveredInfo = '';
        if (item.discrepancies && item.discrepancies.length > 0) {
            // Has delivery exceptions
            const discTypes = item.discrepancies.map(d => d.type).join(', ');
            const totalAffected = item.discrepancies.reduce((sum, d) => sum + (d.qty_affected || 0), 0);
            deliveredInfo = `<span class="text-danger" title="${discTypes}">${item.picked_qty - totalAffected} <i class="fas fa-exclamation-triangle"></i></span>`;
        } else if (item.is_picked) {
            // Picked but no exceptions - assume delivered as picked
            deliveredInfo = `<span class="text-success">${item.picked_qty}</span>`;
        } else {
            // Not picked yet
            deliveredInfo = '-';
        }
        
        html += `
            <tr>
                <td>${item.item_code}</td>
                <td>${item.item_name}</td>
                <td>${item.location}</td>
                <td>${item.zone}</td>
                <td>${item.qty}</td>
                <td>${item.picked_qty}</td>
                <td>${deliveredInfo}</td>
                <td>${item.is_picked ? '<span class="badge bg-success">Picked</span>' : '<span class="badge bg-secondary">Not Picked</span>'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    // Add COD/Payment Records section if available
    if (data.cod_receipts && data.cod_receipts.length > 0) {
        html += `
            <h6 class="text-muted mb-3 mt-4"><i class="fas fa-money-bill-wave me-2"></i>Payment Records (COD)</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Date/Time</th>
                            <th>Route</th>
                            <th>Expected</th>
                            <th>Collected</th>
                            <th>Variance</th>
                            <th>Method</th>
                            <th>Driver</th>
                            <th>PS365 Receipt</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.cod_receipts.forEach(receipt => {
            const varianceClass = receipt.variance != 0 ? 'text-warning' : '';
            html += `
                <tr>
                    <td>${receipt.created_at ? formatDate(receipt.created_at) : '-'}</td>
                    <td>${receipt.route_id ? 'Route #' + receipt.route_id : '-'}</td>
                    <td class="text-end">€${receipt.expected_amount.toFixed(2)}</td>
                    <td class="text-end">€${receipt.received_amount.toFixed(2)}</td>
                    <td class="text-end ${varianceClass}">€${receipt.variance.toFixed(2)}</td>
                    <td>${receipt.payment_method || '-'}</td>
                    <td>${receipt.driver_username || '-'}</td>
                    <td>${receipt.ps365_receipt_id ? '<span class="badge bg-success">' + receipt.ps365_receipt_id + '</span>' : '<span class="badge bg-secondary">Not Sent</span>'}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Add POD Records section if available
    if (data.pod_records && data.pod_records.length > 0) {
        html += `
            <h6 class="text-muted mb-3 mt-4"><i class="fas fa-file-signature me-2"></i>Proof of Delivery</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Date/Time</th>
                            <th>Route</th>
                            <th>Receiver Name</th>
                            <th>Physical Invoice</th>
                            <th>Collected By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.pod_records.forEach(pod => {
            html += `
                <tr>
                    <td>${pod.collected_at ? formatDate(pod.collected_at) : '-'}</td>
                    <td>${pod.route_id ? 'Route #' + pod.route_id : '-'}</td>
                    <td>${pod.receiver_name || '-'}</td>
                    <td>${pod.has_physical_signed_invoice ? '<i class="fas fa-check text-success"></i> Yes' : '<i class="fas fa-times text-danger"></i> No'}</td>
                    <td>${pod.collected_by || '-'}</td>
                    <td>${pod.notes || '-'}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Add routing history section if available
    if (data.routing_history && data.routing_history.length > 0) {
        html += `
            <h6 class="text-muted mb-3 mt-4"><i class="fas fa-route me-2"></i>Routing History</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Date/Time</th>
                            <th>Action</th>
                            <th>Route</th>
                            <th>Reason</th>
                            <th>Notes</th>
                            <th>By</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.routing_history.forEach(history => {
            const actionBadge = history.action === 'SENT_TO_WAREHOUSE' ? 'badge bg-warning' :
                               history.action === 'REROUTE_QUEUED' ? 'badge bg-info' :
                               history.action === 'RETURN_TO_STOCK' ? 'badge bg-secondary' :
                               history.action === 'CLOSED' ? 'badge bg-success' : 'badge bg-primary';
            
            html += `
                <tr>
                    <td>${history.created_at ? formatDate(history.created_at) : '-'}</td>
                    <td><span class="${actionBadge}">${history.action}</span></td>
                    <td>${history.route_id ? 'Route #' + history.route_id : '-'}</td>
                    <td>${history.reason || '-'}</td>
                    <td>${history.notes || '-'}</td>
                    <td>${history.actor_username || '-'}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    document.getElementById('modal-body').innerHTML = html;
}

function clearFilters() {
    document.getElementById('filter-search').value = '';
    document.getElementById('filter-preset').value = '';
    document.getElementById('filter-completed-from').value = '';
    document.getElementById('filter-completed-to').value = '';
    document.getElementById('filter-delivered-from').value = '';
    document.getElementById('filter-delivered-to').value = '';
    document.getElementById('filter-customer').value = '';
    document.getElementById('filter-route').value = '';
    document.getElementById('filter-driver').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-sort').value = 'completed_desc';
    
    // Reset view
    currentView = 'list';
    document.getElementById('btn-group-view').innerHTML = '<i class="fas fa-layer-group me-1"></i>Group by Route';
    document.getElementById('btn-group-view').style.display = 'none';
    
    document.getElementById('empty-state').innerHTML = `
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <p class="text-muted">Use the filters to search for completed invoices</p>
    `;
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('results-container').style.display = 'none';
    document.getElementById('grouped-container').style.display = 'none';
    document.getElementById('kpi-section').style.display = 'none';
}

function previousPage() {
    if (currentPage > 1) {
        searchInvoices(currentPage - 1);
    }
}

function nextPage() {
    if (currentPage * pageSize < totalCount) {
        searchInvoices(currentPage + 1);
    }
}

function printInvoiceDetail() {
    window.print();
}

function toggleGroupView() {
    if (currentView === 'list') {
        currentView = 'group';
        document.getElementById('btn-group-view').innerHTML = '<i class="fas fa-list me-1"></i>Show List';
        renderGroupedView(currentResults.items);
    } else {
        currentView = 'list';
        document.getElementById('btn-group-view').innerHTML = '<i class="fas fa-layer-group me-1"></i>Group by Route';
        renderListView(currentResults.items);
    }
}

function renderGroupedView(items) {
    document.getElementById('results-container').style.display = 'none';
    document.getElementById('grouped-container').style.display = 'block';
    
    // Group items by route
    const grouped = {};
    items.forEach(item => {
        const routeKey = item.route_id || 'no-route';
        if (!grouped[routeKey]) {
            grouped[routeKey] = {
                route_id: item.route_id,
                route_name: item.route_name,
                driver_name: item.driver_name,
                delivery_date: item.delivery_date,
                invoices: [],
                total_items: 0,
                total_weight: 0
            };
        }
        grouped[routeKey].invoices.push(item);
        grouped[routeKey].total_items += item.total_items || 0;
        grouped[routeKey].total_weight += item.total_weight || 0;
    });
    
    // Render grouped results - sort by delivery date ascending
    let html = '';
    Object.keys(grouped).sort((a, b) => {
        if (a === 'no-route') return 1;
        if (b === 'no-route') return -1;
        
        const dateA = grouped[a].delivery_date;
        const dateB = grouped[b].delivery_date;
        
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        
        // Sort by delivery date ascending (earliest first)
        return new Date(dateA) - new Date(dateB);
    }).forEach(routeKey => {
        const group = grouped[routeKey];
        const routeTitle = group.route_id 
            ? `Route #${group.route_id}${group.route_name ? ' - ' + group.route_name : ''}`
            : 'No Route Assigned';
        
        html += `
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-route me-2"></i>${routeTitle}</h6>
                    <div>
                        <span class="badge bg-light text-dark me-2">${group.driver_name || 'No Driver'}</span>
                        <span class="badge bg-light text-dark me-2">${group.invoices.length} invoices</span>
                        <span class="badge bg-light text-dark me-2">${group.total_items} items</span>
                        <span class="badge bg-light text-dark">${group.total_weight.toFixed(2)} kg</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Picked</th>
                                    <th>Delivered</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Lines</th>
                                    <th>Items</th>
                                    <th>Weight (kg)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Sort invoices within the route by delivery date ascending
        const sortedInvoices = [...group.invoices].sort((a, b) => {
            const dateA = a.delivered_at;
            const dateB = b.delivered_at;
            
            if (!dateA && !dateB) return 0;
            if (!dateA) return 1;
            if (!dateB) return -1;
            
            return new Date(dateA) - new Date(dateB);
        });
        
        sortedInvoices.forEach(item => {
            html += `
                <tr>
                    <td><strong>${item.invoice_no}</strong></td>
                    <td>${item.completed_at ? formatDate(item.completed_at) : '-'}</td>
                    <td>${item.delivered_at ? formatDate(item.delivered_at) : '-'}</td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${item.customer_name}">
                            ${item.customer_code ? item.customer_code + ' - ' : ''}${item.customer_name}
                        </div>
                    </td>
                    <td>${getStatusBadge(item.status)}</td>
                    <td>${item.total_lines}</td>
                    <td>${item.total_items}</td>
                    <td>${item.total_weight}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvoiceDetail('${item.invoice_no}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('grouped-routes').innerHTML = html;
    document.getElementById('result-count').textContent = `${totalCount} results`;
}

// Auto-search on preset change
document.getElementById('filter-preset').addEventListener('change', function() {
    if (this.value) {
        searchInvoices(1);
    }
});
</script>
{% endblock %}
