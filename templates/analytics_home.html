{% extends "base.html" %}

{% block title %}Customer Opportunity Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">ðŸ“Š Customer Opportunity Analytics</h1>
                    <p class="text-muted">Cross-sell opportunities, churn risks, and market insights</p>
                </div>
                <div>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Run Analytics Jobs -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="post" action="{{ url_for('analytics.run_analytics_jobs') }}" style="display:inline;">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-sync me-1"></i> Refresh Analytics Data
                        </button>
                    </form>
                    <a href="{{ url_for('analytics.top_opportunities') }}" class="btn btn-info">
                        <i class="fas fa-star me-1"></i> View Top Opportunities
                    </a>
                    <a href="{{ url_for('analytics.analytics_help') }}" class="btn btn-secondary">
                        <i class="fas fa-question-circle me-1"></i> Learn More
                    </a>
                </div>
            </div>

            <!-- Customer Search & Selector (Hidden when customer is selected) -->
            {% if not selected_customer %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Search & Select Customer</h5>
                </div>
                <div class="card-body">
                    <form method="get" action="">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="search" class="form-label">Search by Code or Name (3+ characters):</label>
                                <input type="text" id="search" name="search" class="form-control" 
                                       placeholder="e.g., ABC or Acme" value="{{ search_query or '' }}">
                                <small class="text-muted">Type 3+ characters to search</small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-magnifying-glass me-1"></i>Search
                                </button>
                                <a href="{{ url_for('analytics.analytics_home') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Clear
                                </a>
                            </div>
                        </div>
                    </form>

                    {% if search_query and search_query|length < 3 %}
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-info-circle me-2"></i>Please enter at least 3 characters to search.
                        </div>
                    {% elif customers %}
                        <div class="mb-3">
                            <label class="form-label">{{ customers|length }} customer(s) found:</label>
                            <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                {% for code, name in customers %}
                                    <a href="{{ url_for('analytics.analytics_home', customer=code) }}" 
                                       class="list-group-item list-group-item-action {% if code == selected_customer %}active{% endif %}">
                                        <strong>{{ code }}</strong> - {{ name }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% elif search_query %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-search me-2"></i>No customers found matching "{{ search_query }}"
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>Enter a search term (3+ characters) to find customers by code or name.
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if selected_customer and customer_data %}
                <!-- Customer Header with Back Button -->
                <div class="card mb-4 bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1">{{ selected_customer }}</h3>
                                <p class="mb-0 text-light">{{ selected_customer_name }}</p>
                            </div>
                            <a href="{{ url_for('analytics.analytics_home') }}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-1"></i> Change Customer
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Share of Wallet -->
                <div class="card mb-4">
                    <div class="card-header bg-light text-dark">
                        <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Share of Wallet</h5>
                    </div>
                    <div class="card-body">
                        {% if customer_data.share_of_wallet %}
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6 class="text-muted">Actual Spend</h6>
                                        <h4 class="text-primary">{{ "%.2f"|format(customer_data.share_of_wallet.actual_spend) }}</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6 class="text-muted">Average Spend</h6>
                                        <h4 class="text-info">{{ "%.2f"|format(customer_data.share_of_wallet.avg_spend) }}</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6 class="text-muted">Opportunity Gap</h6>
                                        <h4 class="text-success">{{ "%.2f"|format(customer_data.share_of_wallet.opportunity_gap) }}</h4>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No share-of-wallet data available.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Missing Categories -->
                <div class="card mb-4">
                    <div class="card-header bg-light text-dark">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Missing Categories ({{ customer_data.missing_categories|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if customer_data.missing_categories %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Category Code</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in customer_data.missing_categories %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-warning">{{ row.category_code }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">This customer has purchased from all known categories! ðŸŽ‰</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Churn Risk -->
                <div class="card mb-4">
                    <div class="card-header bg-light text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Churn Risk by Category ({{ customer_data.churn_risks|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if customer_data.churn_risks %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Category</th>
                                            <th>Previous Spend</th>
                                            <th>Recent Spend</th>
                                            <th>Drop %</th>
                                            <th>Risk Flag</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in customer_data.churn_risks %}
                                            <tr>
                                                <td><strong>{{ row.category_code }}</strong></td>
                                                <td>{{ "%.2f"|format(row.prev_spend) }}</td>
                                                <td>{{ "%.2f"|format(row.recent_spend) }}</td>
                                                <td>{{ "%.1f"|format(row.drop_pct * 100) }}%</td>
                                                <td>
                                                    {% if row.churn_flag == 1 %}
                                                        <span class="badge bg-danger">HIGH RISK</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Stable</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No churn risk detected for this customer.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Product Recommendations -->
                <div class="card mb-4">
                    <div class="card-header bg-light text-dark">
                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Product Recommendations ({{ customer_data.recommendations|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if customer_data.recommendations %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>From Item</th>
                                            <th>â†’ Recommended Item</th>
                                            <th>Confidence</th>
                                            <th>Lift</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in customer_data.recommendations %}
                                            <tr>
                                                <td>
                                                    <div><code>{{ r.from_item_code }}</code></div>
                                                    <small class="text-muted">{{ r.from_item_name }}</small>
                                                </td>
                                                <td>
                                                    <div><code>{{ r.to_item_code }}</code></div>
                                                    <small class="text-muted">{{ r.to_item_name }}</small>
                                                </td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-success" role="progressbar" 
                                                             style="width: {{ (r.confidence * 100)|int }}%">
                                                            {{ "%.1f"|format(r.confidence * 100) }}%
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if r.lift %}
                                                        <span class="badge bg-info">{{ "%.2f"|format(r.lift) }}x</span>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No recommendations available yet. Run refresh to generate insights.</p>
                        {% endif %}
                    </div>
                </div>

            {% elif selected_customer %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No analytics data available for this customer yet. Please click "Refresh Analytics Data" to generate insights.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
