<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Invoices to Batch {{ batch.id }} - EPLATTFORMA Picking System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-plus-circle text-success me-2"></i>Add Invoices to Batch</h2>
                        <h5 class="text-muted">Batch {{ batch.id }}: {{ batch.name }}</h5>
                    </div>
                    <a href="{{ url_for('batch.batch_picking_manage') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Batch Management
                    </a>
                </div>

                <!-- Batch Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Batch Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Batch ID:</strong> {{ batch.id }}
                            </div>
                            <div class="col-md-3">
                                <strong>Status:</strong> 
                                <span class="badge bg-primary">{{ batch.status }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Zones:</strong> {{ zones|join(', ') }}
                            </div>
                            <div class="col-md-3">
                                <strong>Corridors:</strong> {{ corridors|join(', ') if corridors else 'All' }}
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <strong>Picking Mode:</strong> {{ batch.picking_mode }}
                            </div>
                            <div class="col-md-3">
                                <strong>Assigned To:</strong> {{ batch.assigned_to or 'Unassigned' }}
                            </div>
                            <div class="col-md-6">
                                <strong>Current Invoices:</strong> {{ batch.invoices|length }} invoices
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Invoices Form -->
                {% if available_invoices %}
                <form method="POST">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-invoice me-2"></i>
                                Available Invoices ({{ available_invoices|length }})
                            </h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                                    <i class="fas fa-check-square me-1"></i>Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAll()">
                                    <i class="fas fa-square me-1"></i>Clear All
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Showing invoices that match the batch zones/corridors and are not already in this batch.
                                Invoices are sorted by routing number (descending) for optimal picking sequence.
                            </p>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="5%">
                                                <input type="checkbox" id="selectAllCheckbox" onclick="toggleAll()">
                                            </th>
                                            <th width="15%">Invoice No</th>
                                            <th width="45%">Customer</th>
                                            <th width="15%">Routing</th>
                                            <th width="15%">Items</th>
                                            <th width="5%"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for invoice in available_invoices %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" 
                                                       name="selected_invoices" 
                                                       value="{{ invoice.invoice_no }}"
                                                       class="invoice-checkbox">
                                            </td>
                                            <td>
                                                <strong>{{ invoice.invoice_no }}</strong>
                                            </td>
                                            <td>{{ invoice.customer_name or 'Unknown Customer' }}</td>
                                            <td>
                                                {% if invoice.routing %}
                                                    <span class="badge bg-info">{{ invoice.routing }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No Routing</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-success">{{ invoice.item_count }} items</span>
                                            </td>
                                            <td>
                                                <i class="fas fa-plus-circle text-success" title="Add to batch"></i>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Selected invoices will be added to the batch in routing number descending order for optimal picking sequence.
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus me-2"></i>Add Selected Invoices to Batch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Available Invoices</h4>
                        <p class="text-muted">
                            All invoices matching the batch criteria (zones: {{ zones|join(', ') }}{% if corridors %}, corridors: {{ corridors|join(', ') }}{% endif %}) 
                            are either already in this batch or locked by other active batches.
                        </p>
                        <a href="{{ url_for('batch.batch_picking_manage') }}" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Batch Management
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function selectAll() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateSelectAllCheckbox();
        }

        function clearAll() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectAllCheckbox();
        }

        function toggleAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkedCount = document.querySelectorAll('.invoice-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // Add event listeners to individual checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectAllCheckbox);
            });
            updateSelectAllCheckbox();
        });
    </script>
</body>
</html>