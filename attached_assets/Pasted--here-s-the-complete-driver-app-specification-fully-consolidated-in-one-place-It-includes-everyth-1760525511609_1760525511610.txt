 here‚Äôs the complete driver app specification, fully consolidated in one place.
It includes everything we‚Äôve discussed: the route and stop flow, COD & POD handling, settlement process, integration with your existing Delivery Discrepancy system, and the exception-only delivery mode.
________________________________________
üöö DRIVER APP ‚Äî END-TO-END SPEC (Flask + PostgreSQL + Bootstrap + Vanilla JS)
Version: v2
Environment: Replit
Backend: Flask + SQLAlchemy + PostgreSQL
Frontend: Jinja2 Templates + Bootstrap 5 + Vanilla JS
Printing: HTML + optional Web Bluetooth (ESC/POS)
Offline (future): PWA + IndexedDB
Date: 2025-10-15
________________________________________
0Ô∏è‚É£ Environment Overview
Runtime: Replit (dev) / Gunicorn (prod)
Backend: Flask (Python), SQLAlchemy ORM, PostgreSQL
Frontend: Jinja2 (SSR) + Bootstrap 5 + Vanilla JS (no React/Vue)
Deployment: Gunicorn + Nginx
Design goal: mobile-optimized, offline-tolerant driver app
________________________________________
1Ô∏è‚É£ System Rules & Roles
‚Ä¢	Driver: Can view routes, record deliveries/failures, capture COD/POD, and report discrepancies.
‚Ä¢	Admin/Warehouse: Create routes, assign drivers, validate discrepancies, resolve, and complete routes.
‚Ä¢	Picker: Can view issues related to their picks and provide self-validation.
Important business rule:
A driver may have only one active route (IN_TRANSIT) at a time.
The Admin finalizes (COMPLETED) only after cash and returns are cleared.
________________________________________
2Ô∏è‚É£ Status Reference
Invoice Statuses
not_started ‚Üí picking ‚Üí ready_for_dispatch ‚Üí shipped ‚Üí out_for_delivery ‚Üí delivered
Other: delivery_failed, returned_to_warehouse, cancelled
Route Statuses
created ‚Üí PLANNED ‚Üí DISPATCHED ‚Üí IN_TRANSIT ‚Üí COMPLETED
Other: CANCELLED
Stop Invoice Statuses
ASSIGNED ‚Üí READY_TO_DISPATCH ‚Üí DISPATCHED ‚Üí DELIVERED ‚Üí FAILED
When a route starts (IN_TRANSIT), all invoices become out_for_delivery.
________________________________________
3Ô∏è‚É£ Route Flow
1.	Admin dispatches route ‚Üí status DISPATCHED.
2.	Driver starts ‚Üí IN_TRANSIT.
3.	Each stop is completed (Delivered / Failed).
4.	Driver submits route after last stop.
5.	Admin completes route after clearing cash & returns.
________________________________________
4Ô∏è‚É£ Routes Dashboard
Shown to driver:
‚Ä¢	Route #, Date, Description
‚Ä¢	Progress bar (Delivered / Total)
‚Ä¢	Total items, weight
‚Ä¢	Buttons: View Stops, Run Sheet
‚Ä¢	IN_TRANSIT routes appear first, then DISPATCHED
Guards:
‚Ä¢	Only one active route allowed per driver (backend enforced with 409 conflict).
________________________________________
5Ô∏è‚É£ Stops List Screen
Header:
‚Ä¢	Route #, status chip (DISPATCHED / IN_TRANSIT / Paused)
‚Ä¢	Progress (delivered/total)
‚Ä¢	Buttons:
o	DISPATCHED ‚Üí Start Route
o	IN_TRANSIT ‚Üí Pause/Resume
o	All stops done ‚Üí Finish Route
o	Overflow ‚Üí Return to Depot, Notes, Call Dispatcher
List row:
[Seq]  Customer Name           Items  Weight   Status
12     Coffee Co. Ltd          3      18.4kg   ‚óª Pending
13     FinServe Offices        1      2.2kg    ‚ñ∂ Delivering
14     BluePrint Studios       5      31.0kg   ‚úì Delivered
Gestures:
‚Ä¢	Swipe left ‚Üí Deliver
‚Ä¢	Swipe right ‚Üí Navigate (Google Maps / Waze)
‚Ä¢	Long-press ‚Üí Fail / Skip
________________________________________
6Ô∏è‚É£ Stop Detail Screen
Top Block:
‚Ä¢	Customer: customer_name
‚Ä¢	Address: website (if URL) or address
‚Ä¢	Contact: sms field (used for call and message)
‚Ä¢	COD due: (placeholder for now)
‚Ä¢	Notes: notes
Quick actions:
Navigate ‚Ä¢ Call ‚Ä¢ SMS ‚Ä¢ Chat/WhatsApp (optional)
Invoices list:
INV-XXXX ‚Ä¢ items N ‚Ä¢ weight W ‚Ä¢ status
(Selectable checkboxes per invoice)
________________________________________
7Ô∏è‚É£ Exception-Only Delivery Mode (Updated Step 1)
Concept
‚Ä¢	Everything is assumed delivered by default.
‚Ä¢	Driver records only exceptions for items that have problems.
‚Ä¢	Common cases:
o	Short: less than ordered
o	Damaged: customer rejected or accepted
o	Wrong / Extra: delivered item doesn‚Äôt match invoice
Driver UI
‚Ä¢	Table shows Item | Ordered | Delivered | Exceptions.
‚Ä¢	‚ÄúAdd Exception‚Äù button per item.
‚Ä¢	Modal fields:
o	Type (Short / Damaged / Wrong)
o	Qty (required)
o	For Damaged ‚Üí toggle Accepted by customer
o	Notes (optional)
o	Photos (optional)
‚Ä¢	Exceptions panel lists all recorded issues (editable/removable).
‚Ä¢	Totals auto-update: Ordered / Delivered / Not Delivered.
Delivery logic
For each item:
delivered = ordered - short_qty - damaged_rejected_qty
‚Ä¢	Damaged(accepted) counts as delivered.
‚Ä¢	Damaged(rejected) reduces delivered.
________________________________________
8Ô∏è‚É£ Delivery Discrepancy Integration
We reuse your current system:
‚Ä¢	Tables: delivery_discrepancies, delivery_discrepancy_events, discrepancy_types
‚Ä¢	Lifecycles: reported ‚Üí validated ‚Üí resolved ‚Üí review ‚Üí closed
‚Ä¢	Roles:
o	Driver = create (reported)
o	Admin/Warehouse = validate / resolve / close
o	Picker = self-validation
When driver submits an exception
Creates:
‚Ä¢	delivery_discrepancy with:
o	status='reported'
o	reported_source='driver'
o	reported_by=<driver>
o	discrepancy_type (short_pick, damaged, wrong_item, extra_item, etc.)
o	Photos + notes
‚Ä¢	delivery_discrepancy_event (event_type='created')
Admin workflow (unchanged)
‚Ä¢	Validate: confirm issue, notes
‚Ä¢	Resolve: credit, restock, write-off, supplier return
‚Ä¢	Close: final archive
‚Ä¢	Picker can later mark cause (e.g., wrong location, picker error)
________________________________________
9Ô∏è‚É£ Backend Flow (Deliver Endpoint)
POST /stops/<stop_id>/deliver
{
  "invoice_ids": [123],
  "exceptions": [
    { "item_id": "1001", "type": "SHORT", "qty": 2, "notes": "missing in box" },
    { "item_id": "1002", "type": "DAMAGED", "qty": 1, "damagedAccepted": false, "notes": "crushed corner" },
    { "item_id": null, "type": "WRONG", "qty": 1, "notes": "unexpected SKU X" }
  ],
  "cod": { "received": 73.50, "method": "cash", "note": "shorts credited" },
  "pod": { "has_physical_signed_invoice": true, "photos": [] },
  "gps": { "lat": 35.17, "lng": 33.36 }
}
Server actions
1.	Load ordered items.
2.	Derive delivered quantities.
3.	Write:
o	delivery_lines (with qty_delivered)
o	delivery_discrepancies (reported_source='driver')
o	delivery_discrepancy_events (created)
4.	Compute COD expected from delivered quantities.
5.	Generate COD receipt ‚Üí push to PS365 ‚Üí optional print.
6.	Store POD data.
7.	Update invoice statuses ‚Üí delivered or failed.
________________________________________
üîü COD Collection & Printing
‚Ä¢	Expected: Sum(price √ó delivered qty)
‚Ä¢	Received: driver input (numeric)
‚Ä¢	If variance ‚â† 0 ‚Üí note required.
Receipt printing
‚Ä¢	Route: GET /receipts/<id>/print
‚Ä¢	Output: 58mm HTML with @media print styles.
‚Ä¢	Optional: Web Bluetooth ESC/POS for thermal printers.
Integration
‚Ä¢	Store ps365_receipt_id in cod_receipts
‚Ä¢	Printable via Android/iOS system print
________________________________________
1Ô∏è‚É£1Ô∏è‚É£ POD (Proof of Delivery)
‚Ä¢	Primary: Physical signed invoice
‚Ä¢	Optional: Photo (especially for ‚Äúleave at reception‚Äù)
‚Ä¢	Store in pod_records
‚Ä¢	Fields:
o	has_physical_signed_invoice
o	receiver_name
o	photos[]
o	gps_lat, gps_lng
o	collected_at
o	notes
If no physical copy ‚Üí require receiver name + optional photo.
________________________________________
1Ô∏è‚É£2Ô∏è‚É£ Fail / Skip Flow
‚Ä¢	Modal: reason (Closed / No Answer / Refused / Wrong address / Other)
‚Ä¢	Optional photos and notes
‚Ä¢	Sets invoice ‚Üí delivery_failed
‚Ä¢	Records GPS and timestamp
________________________________________
1Ô∏è‚É£3Ô∏è‚É£ Return to Depot / Early Finish
Driver confirms early return.
All undelivered invoices ‚Üí returned_to_warehouse
Route flagged completion_reason='returned'
Next screen ‚Üí Submit to Office (Settlement).
________________________________________
1Ô∏è‚É£4Ô∏è‚É£ Settlement Flow (Driver Submission)
After finishing:
‚Ä¢	Show expected COD total
‚Ä¢	Input cash handed in
‚Ä¢	Variance auto-calculated (requires note if not zero)
‚Ä¢	Return summary (count, weight, optional crate photos)
‚Ä¢	Notes (damage, incident, comments)
‚Üí Marks settlement_status='DRIVER_SUBMITTED'
Route locked for editing until Admin clearance.
________________________________________
1Ô∏è‚É£5Ô∏è‚É£ Admin Completion
Admin confirms:
‚Ä¢	Cash cleared
‚Ä¢	Returns received
‚Üí Sets settlement_status='SETTLED'
‚Üí Route ‚Üí COMPLETED
________________________________________
1Ô∏è‚É£6Ô∏è‚É£ Guards & Safeguards
‚Ä¢	One IN_TRANSIT route per driver.
‚Ä¢	Must resolve all invoices before finishing.
‚Ä¢	Supervisor PIN required to undo deliveries.
‚Ä¢	Offline queue for unsynced events.
‚Ä¢	Location check (optional geofence near stop).
________________________________________
1Ô∏è‚É£7Ô∏è‚É£ Database Models (Key Entities)
‚Ä¢	Route: driver_id, status, settlement_status, totals, timestamps
‚Ä¢	RouteStop: customer_id, name, address, website, sms, notes
‚Ä¢	RouteStopInvoice: stop_id, invoice_id, items_count, weight, status
‚Ä¢	Invoice: id, number, status, cod_amount
‚Ä¢	DeliveryEvent: id, type, payload, gps, actor
‚Ä¢	DeliveryLine: invoice_id, item_id, qty_ordered, qty_delivered
‚Ä¢	DeliveryDiscrepancy: linked to invoice/item, type, qty_expected/actual, status, source, notes, photos
‚Ä¢	DeliveryDiscrepancyEvent: event_type, actor, timestamp, notes
‚Ä¢	CODReceipt / PODRecord as per specs above
________________________________________
1Ô∏è‚É£8Ô∏è‚É£ Frontend (Jinja Templates)
‚Ä¢	routes.html ‚Üí dashboard list
‚Ä¢	stops.html ‚Üí list + gestures
‚Ä¢	stop_detail.html ‚Üí customer info + invoices
‚Ä¢	deliver_wizard.html ‚Üí Exception entry + COD + POD
‚Ä¢	fail_modal.html ‚Üí reason + photo
‚Ä¢	submission.html ‚Üí cash/returns summary
‚Ä¢	run_sheet.html ‚Üí printable manifest
JS modules:
‚Ä¢	gestures.js ‚Üí swipes/long-press
‚Ä¢	deliver_exceptions.js ‚Üí add/edit/remove exceptions
‚Ä¢	cod.js ‚Üí receipt input + print
‚Ä¢	pod.js ‚Üí signature/photo
‚Ä¢	settlement.js ‚Üí driver submission
________________________________________
1Ô∏è‚É£9Ô∏è‚É£ Audit & Security
‚Ä¢	Every action writes a DeliveryEvent.
‚Ä¢	Each discrepancy adds a DeliveryDiscrepancyEvent.
‚Ä¢	Supervisor PIN for undo or forced status.
‚Ä¢	File validation + EXIF strip.
‚Ä¢	Role-based access enforcement (JWT).
________________________________________
2Ô∏è‚É£0Ô∏è‚É£ Future Enhancements
‚Ä¢	Full PWA (offline, sync retries, photo caching)
‚Ä¢	Signature pad on-screen
‚Ä¢	Reconciliation PDF: route summary + COD + POD + discrepancies
‚Ä¢	Live operations dashboard (WebSocket updates)
________________________________________
‚úÖ In summary:
‚Ä¢	Driver only records exceptions, not full scans.
‚Ä¢	Each exception creates a proper discrepancy record with event tracking.
‚Ä¢	COD and POD remain consistent with your accounting.
‚Ä¢	Admin control over completion ensures proper clearance.
‚Ä¢	Fully compatible with your existing delivery_discrepancies system.
