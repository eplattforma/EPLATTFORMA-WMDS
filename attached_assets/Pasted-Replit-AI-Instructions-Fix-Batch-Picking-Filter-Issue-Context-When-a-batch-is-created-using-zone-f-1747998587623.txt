Replit AI Instructions: Fix Batch Picking Filter Issue
Context:
When a batch is created using zone filters or other conditions, not all eligible items are showing up for picking. Items that exist and meet the criteria are missing from the batch.

üõ†Ô∏è Step 1: Fix Zone Format Handling
Problem:
Zones are stored or passed incorrectly with curly braces or as serialized arrays (e.g., {SENSITIVE} or ['SENSITIVE']), causing filters to fail.

Fix:

In the batch creation process and DB storage, ensure zones are stored as clean strings:

python
Copy code
# Fix zone storage
zone = zone.strip('{}[]')
If using .split(), make sure the result is an actual list of zone names.

üß† Step 2: Fix Filtering Logic During Batch Creation
In the backend logic that selects items for batch picking (likely in models.py or routes_batch.py), make sure filters are correctly applied.

Update the item filtering logic:

python
Copy code
filtered_items = (
  db.query(InvoiceItem)
  .filter(InvoiceItem.zone.in_(zone_filter))
  .filter(InvoiceItem.pick_status.in_(['not_picked', 'reset', 'skipped_pending']))
  .filter(InvoiceItem.is_picked == False)
  .all()
)
Add debug logging before and after the query to confirm the zones and results:

python
Copy code
print("Zones passed:", zone_filter)
print("Filtered items found:", len(filtered_items))
üß™ Step 3: Validate Items Exist
After batch creation and before starting picking, validate that items are found:

python
Copy code
if not filtered_items:
    print("‚ö†Ô∏è No items found for selected zone(s). Check filter criteria or DB.")
    # Optionally prevent batch creation if no items match
üßπ Step 4: Clean Up Existing Faulty Zones
Ensure any previously stored zones in batch_picking_sessions that include curly braces are corrected:

SQL fix (if needed):

sql
Copy code
UPDATE batch_picking_sessions
SET zones = REPLACE(zones, '{', '')
WHERE zones LIKE '{%';
UPDATE batch_picking_sessions
SET zones = REPLACE(zones, '}', '')
WHERE zones LIKE '%}';
‚úÖ Step 5: Retest Batch Picking End-to-End
Create a new batch with filtered zone

Confirm eligible items are assigned

Confirm batch shows correct items during picking

