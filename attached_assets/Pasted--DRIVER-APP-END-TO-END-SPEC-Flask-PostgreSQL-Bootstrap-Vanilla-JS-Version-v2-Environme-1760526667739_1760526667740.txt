üöö DRIVER APP ‚Äî END-TO-END SPEC (Flask + PostgreSQL + Bootstrap + Vanilla JS)

Version: v2
Environment: Replit
Backend: Flask + SQLAlchemy + PostgreSQL
Frontend: Jinja2 Templates + Bootstrap 5 + Vanilla JS
Printing: HTML + optional Web Bluetooth (ESC/POS)
Offline (future): PWA + IndexedDB
Date: 2025-10-15

0Ô∏è‚É£ Environment Overview

Runtime: Replit (dev) / Gunicorn (prod)
Backend: Flask (Python), SQLAlchemy ORM, PostgreSQL
Frontend: Jinja2 (SSR) + Bootstrap 5 + Vanilla JS (no React/Vue)
Deployment: Gunicorn + Nginx
Design goal: mobile-optimized, offline-tolerant driver app

1Ô∏è‚É£ System Rules & Roles

Driver: Can view routes, record deliveries/failures, capture COD/POD, and report discrepancies.

Admin/Warehouse: Create routes, assign drivers, validate discrepancies, resolve, and complete routes.

Picker: Can view issues related to their picks and provide self-validation.

Important business rule:

A driver may have only one active route (IN_TRANSIT) at a time.
The Admin finalizes (COMPLETED) only after cash and returns are cleared.

2Ô∏è‚É£ Status Reference
Invoice Statuses
not_started ‚Üí picking ‚Üí ready_for_dispatch ‚Üí shipped ‚Üí out_for_delivery ‚Üí delivered


Other: delivery_failed, returned_to_warehouse, cancelled

Route Statuses
created ‚Üí PLANNED ‚Üí DISPATCHED ‚Üí IN_TRANSIT ‚Üí COMPLETED


Other: CANCELLED

Stop Invoice Statuses
ASSIGNED ‚Üí READY_TO_DISPATCH ‚Üí DISPATCHED ‚Üí DELIVERED ‚Üí FAILED


When a route starts (IN_TRANSIT), all invoices become out_for_delivery.

3Ô∏è‚É£ Route Flow

Admin dispatches route ‚Üí status DISPATCHED.

Driver starts ‚Üí IN_TRANSIT.

Each stop is completed (Delivered / Failed).

Driver submits route after last stop.

Admin completes route after clearing cash & returns.

4Ô∏è‚É£ Routes Dashboard

Shown to driver:

Route #, Date, Description

Progress bar (Delivered / Total)

Total items, weight

Buttons: View Stops, Run Sheet

IN_TRANSIT routes appear first, then DISPATCHED

Guards:

Only one active route allowed per driver (backend enforced with 409 conflict).

5Ô∏è‚É£ Stops List Screen

Header:

Route #, status chip (DISPATCHED / IN_TRANSIT / Paused)

Progress (delivered/total)

Buttons:

DISPATCHED ‚Üí Start Route

IN_TRANSIT ‚Üí Pause/Resume

All stops done ‚Üí Finish Route

Overflow ‚Üí Return to Depot, Notes, Call Dispatcher

List row:

[Seq]  Customer Name           Items  Weight   Status
12     Coffee Co. Ltd          3      18.4kg   ‚óª Pending
13     FinServe Offices        1      2.2kg    ‚ñ∂ Delivering
14     BluePrint Studios       5      31.0kg   ‚úì Delivered


Gestures:

Swipe left ‚Üí Deliver

Swipe right ‚Üí Navigate (Google Maps / Waze)

Long-press ‚Üí Fail / Skip

6Ô∏è‚É£ Stop Detail Screen

Top Block:

Customer: customer_name

Address: website (if URL) or address

Contact: sms field (used for call and message)

COD due: (placeholder for now)

Notes: notes

Quick actions:
Navigate ‚Ä¢ Call ‚Ä¢ SMS ‚Ä¢ Chat/WhatsApp (optional)

Invoices list:
INV-XXXX ‚Ä¢ items N ‚Ä¢ weight W ‚Ä¢ status
(Selectable checkboxes per invoice)

7Ô∏è‚É£ Exception-Only Delivery Mode (Updated Step 1)
Concept

Everything is assumed delivered by default.

Driver records only exceptions for items that have problems.

Common cases:

Short: less than ordered

Damaged: customer rejected or accepted

Wrong / Extra: delivered item doesn‚Äôt match invoice

Driver UI

Table shows Item | Ordered | Delivered | Exceptions.

‚ÄúAdd Exception‚Äù button per item.

Modal fields:

Type (Short / Damaged / Wrong)

Qty (required)

For Damaged ‚Üí toggle Accepted by customer

Notes (optional)

Photos (optional)

Exceptions panel lists all recorded issues (editable/removable).

Totals auto-update: Ordered / Delivered / Not Delivered.

Delivery logic

For each item:

delivered = ordered - short_qty - damaged_rejected_qty


Damaged(accepted) counts as delivered.

Damaged(rejected) reduces delivered.

8Ô∏è‚É£ Delivery Discrepancy Integration

We reuse your current system:

Tables: delivery_discrepancies, delivery_discrepancy_events, discrepancy_types

Lifecycles: reported ‚Üí validated ‚Üí resolved ‚Üí review ‚Üí closed

Roles:

Driver = create (reported)

Admin/Warehouse = validate / resolve / close

Picker = self-validation

When driver submits an exception

Creates:

delivery_discrepancy with:

status='reported'

reported_source='driver'

reported_by=<driver>

discrepancy_type (short_pick, damaged, wrong_item, extra_item, etc.)

Photos + notes

delivery_discrepancy_event (event_type='created')

Admin workflow (unchanged)

Validate: confirm issue, notes

Resolve: credit, restock, write-off, supplier return

Close: final archive

Picker can later mark cause (e.g., wrong location, picker error)

9Ô∏è‚É£ Backend Flow (Deliver Endpoint)

POST /stops/<stop_id>/deliver

{
  "invoice_ids": [123],
  "exceptions": [
    { "item_id": "1001", "type": "SHORT", "qty": 2, "notes": "missing in box" },
    { "item_id": "1002", "type": "DAMAGED", "qty": 1, "damagedAccepted": false, "notes": "crushed corner" },
    { "item_id": null, "type": "WRONG", "qty": 1, "notes": "unexpected SKU X" }
  ],
  "cod": { "received": 73.50, "method": "cash", "note": "shorts credited" },
  "pod": { "has_physical_signed_invoice": true, "photos": [] },
  "gps": { "lat": 35.17, "lng": 33.36 }
}

Server actions

Load ordered items.

Derive delivered quantities.

Write:

delivery_lines (with qty_delivered)

delivery_discrepancies (reported_source='driver')

delivery_discrepancy_events (created)

Compute COD expected from delivered quantities.

Generate COD receipt ‚Üí push to PS365 ‚Üí optional print.

Store POD data.

Update invoice statuses ‚Üí delivered or failed.

üîü COD Collection & Printing

Expected: Sum(price √ó delivered qty)

Received: driver input (numeric)

If variance ‚â† 0 ‚Üí note required.

Receipt printing

Route: GET /receipts/<id>/print

Output: 58mm HTML with @media print styles.

Optional: Web Bluetooth ESC/POS for thermal printers.

Integration

Store ps365_receipt_id in cod_receipts

Printable via Android/iOS system print

1Ô∏è‚É£1Ô∏è‚É£ POD (Proof of Delivery)

Primary: Physical signed invoice

Optional: Photo (especially for ‚Äúleave at reception‚Äù)

Store in pod_records

Fields:

has_physical_signed_invoice

receiver_name

photos[]

gps_lat, gps_lng

collected_at

notes

If no physical copy ‚Üí require receiver name + optional photo.

1Ô∏è‚É£2Ô∏è‚É£ Fail / Skip Flow

Modal: reason (Closed / No Answer / Refused / Wrong address / Other)

Optional photos and notes

Sets invoice ‚Üí delivery_failed

Records GPS and timestamp

1Ô∏è‚É£3Ô∏è‚É£ Return to Depot / Early Finish

Driver confirms early return.
All undelivered invoices ‚Üí returned_to_warehouse
Route flagged completion_reason='returned'
Next screen ‚Üí Submit to Office (Settlement).

1Ô∏è‚É£4Ô∏è‚É£ Settlement Flow (Driver Submission)

After finishing:

Show expected COD total

Input cash handed in

Variance auto-calculated (requires note if not zero)

Return summary (count, weight, optional crate photos)

Notes (damage, incident, comments)

‚Üí Marks settlement_status='DRIVER_SUBMITTED'
Route locked for editing until Admin clearance.

1Ô∏è‚É£5Ô∏è‚É£ Admin Completion

Admin confirms:

Cash cleared

Returns received
‚Üí Sets settlement_status='SETTLED'
‚Üí Route ‚Üí COMPLETED

1Ô∏è‚É£6Ô∏è‚É£ Guards & Safeguards

One IN_TRANSIT route per driver.

Must resolve all invoices before finishing.

Supervisor PIN required to undo deliveries.

Offline queue for unsynced events.

Location check (optional geofence near stop).

1Ô∏è‚É£7Ô∏è‚É£ Database Models (Key Entities)

Route: driver_id, status, settlement_status, totals, timestamps

RouteStop: customer_id, name, address, website, sms, notes

RouteStopInvoice: stop_id, invoice_id, items_count, weight, status

Invoice: id, number, status, cod_amount

DeliveryEvent: id, type, payload, gps, actor

DeliveryLine: invoice_id, item_id, qty_ordered, qty_delivered

DeliveryDiscrepancy: linked to invoice/item, type, qty_expected/actual, status, source, notes, photos

DeliveryDiscrepancyEvent: event_type, actor, timestamp, notes

CODReceipt / PODRecord as per specs above

1Ô∏è‚É£8Ô∏è‚É£ Frontend (Jinja Templates)

routes.html ‚Üí dashboard list

stops.html ‚Üí list + gestures

stop_detail.html ‚Üí customer info + invoices

deliver_wizard.html ‚Üí Exception entry + COD + POD

fail_modal.html ‚Üí reason + photo

submission.html ‚Üí cash/returns summary

run_sheet.html ‚Üí printable manifest

JS modules:

gestures.js ‚Üí swipes/long-press

deliver_exceptions.js ‚Üí add/edit/remove exceptions

cod.js ‚Üí receipt input + print

pod.js ‚Üí signature/photo

settlement.js ‚Üí driver submission

1Ô∏è‚É£9Ô∏è‚É£ Audit & Security

Every action writes a DeliveryEvent.

Each discrepancy adds a DeliveryDiscrepancyEvent.

Supervisor PIN for undo or forced status.

File validation + EXIF strip.

Role-based access enforcement (JWT).

2Ô∏è‚É£0Ô∏è‚É£ Future Enhancements

Full PWA (offline, sync retries, photo caching)

Signature pad on-screen

Reconciliation PDF: route summary + COD + POD + discrepancies

Live operations dashboard (WebSocket updates)

‚úÖ In summary:

Driver only records exceptions, not full scans.

Each exception creates a proper discrepancy record with event tracking.

COD and POD remain consistent with your accounting.

Admin control over completion ensures proper clearance.

Fully compatible with your existing delivery_discrepancies system.